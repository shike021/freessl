# 详细设计文档

## 系统概述
这个方案将构建一个基于Let's Encrypt的免费SSL证书服务，提供证书申请、自动化验证、到期提醒和续期服务。

## 用户数据模型设计
```python
from mongoengine import Document, StringField, EmailField, DateTimeField, ListField, ReferenceField
from werkzeug.security import generate_password_hash, check_password_hash
import re

class User(Document):
    username = StringField(required=True, unique=True, min_length=3, max_length=50)
    email = EmailField(required=True, unique=True)
    password_hash = StringField(required=True)
    created_at = DateTimeField(default=datetime.now)
    verified = BooleanField(default=False)
    verification_token = StringField()
    reset_token = StringField()

    def set_password(self, password):
        if len(password) < 8:
            raise ValueError("Password must be at least 8 characters long")
        if not re.search(r'\d', password) or not re.search(r'[A-Za-z]', password):
            raise ValueError("Password must contain both letters and numbers")
        self.password_hash = generate_password_hash(password)
    
    def check_password(self, password):
        return check_password_hash(self.password_hash, password)
    
    def generate_verification_token(self):
        self.verification_token = generate_password_hash(self.email + str(datetime.now()))[:50]
        return self.verification_token
    
    def generate_reset_token(self):
        self.reset_token = generate_password_hash(self.email + str(datetime.now()))[:50]
        return self.reset_token
```

## 认证服务实现
```python
import jwt
from datetime import datetime, timedelta
from flask import current_app
from werkzeug.exceptions import Unauthorized
from models.user_model import User

class AuthService:
    @staticmethod
    def generate_token(user_id):
        payload = {
            'exp': datetime.now() + timedelta(days=1),
            'iat': datetime.now(),
            'sub': str(user_id)
        }
        return jwt.encode(
            payload,
            current_app.config['SECRET_KEY'],
            algorithm='HS256'
        )
    
    @staticmethod
    def decode_token(token):
        try:
            payload = jwt.decode(
                token,
                current_app.config['SECRET_KEY'],
                algorithms=['HS256']
            )
            return payload['sub']
        except jwt.ExpiredSignatureError:
            raise Unauthorized('Token expired. Please log in again.')
        except jwt.InvalidTokenError:
            raise Unauthorized('Invalid token. Please log in again.')
    
    @staticmethod
    def authenticate(username, password):
        user = User.objects(username=username).first()
        if not user or not user.check_password(password):
            return None
        return user
    
    @staticmethod
    def get_current_user(request):
        token = request.headers.get('Authorization')
        if not token or not token.startswith('Bearer '):
            raise Unauthorized('Missing or invalid authorization header')
        
        user_id = AuthService.decode_token(token[7:])
        return User.objects.get(id=user_id)
```

## 用户相关路由
```python
from flask import Blueprint, request, jsonify
from models.user_model import User
from services.auth_service import AuthService
from services.email_service import EmailService

auth_bp = Blueprint('auth', __name__, url_prefix='/api/auth')

@auth_bp.route('/register', methods=['POST'])
def register():
    data = request.json
    
    if not data.get('username') or not data.get('email') or not data.get('password'):
        return jsonify({'error': 'Missing required fields'}), 400
    
    try:
        user = User(
            username=data['username'],
            email=data['email']
        )
        user.set_password(data['password'])
        user.generate_verification_token()
        user.save()
        
        # 发送验证邮件
        EmailService.send_verification_email(user)
        
        return jsonify({
            'message': 'User created successfully. Please check your email to verify your account.'
        }), 201
    except Exception as e:
        return jsonify({'error': str(e)}), 400

@auth_bp.route('/login', methods=['POST'])
def login():
    data = request.json
    
    if not data.get('username') or not data.get('password'):
        return jsonify({'error': 'Missing username or password'}), 400
    
    user = AuthService.authenticate(data['username'], data['password'])
    if not user:
        return jsonify({'error': 'Invalid username or password'}), 401
    
    if not user.verified:
        return jsonify({'error': 'Account not verified. Please check your email.'}), 403
    
    token = AuthService.generate_token(user.id)
    return jsonify({
        'token': token,
        'user': {
            'id': str(user.id),
            'username': user.username,
            'email': user.email
        }
    })

@auth_bp.route('/verify/<token>', methods=['GET'])
def verify(token):
    user = User.objects(verification_token=token).first()
    if not user:
        return jsonify({'error': 'Invalid verification token'}), 400
    
    user.verified = True
    user.verification_token = None
    user.save()
    
    return jsonify({'message': 'Account verified successfully'})

@auth_bp.route('/forgot-password', methods=['POST'])
def forgot_password():
    email = request.json.get('email')
    if not email:
        return jsonify({'error': 'Email is required'}), 400
    
    user = User.objects(email=email).first()
    if user:
        reset_token = user.generate_reset_token()
        user.save()
        EmailService.send_password_reset_email(user, reset_token)
    
    # 即使没有找到用户也返回成功以防止枚举攻击
    return jsonify({'message': 'If the email exists, a reset link has been sent'})

@auth_bp.route('/reset-password', methods=['POST'])
def reset_password():
    token = request.json.get('token')
    new_password = request.json.get('new_password')
    
    if not token or not new_password:
        return jsonify({'error': 'Token and new password are required'}), 400
    
    user = User.objects(reset_token=token).first()
    if not user:
        return jsonify({'error': 'Invalid reset token'}), 400
    
    try:
        user.set_password(new_password)
        user.reset_token = None
        user.save()
        return jsonify({'message': 'Password reset successfully'})
    except ValueError as e:
        return jsonify({'error': str(e)}), 400
```

## 证书路由更新
```python
from flask import Blueprint, request, jsonify
from services.auth_service import AuthService
from services.cert_service import CertService
from models.cert_model import Certificate
from datetime import datetime, timedelta

cert_bp = Blueprint('cert', __name__, url_prefix='/api/certs')

@cert_bp.route('', methods=['GET'])
def list_certs():
    user = AuthService.get_current_user(request)
    certs = Certificate.objects(user=user).order_by('-issue_date')
    return jsonify([{
        'id': str(cert.id),
        'domains': cert.domains,
        'issue_date': cert.issue_date.isoformat(),
        'expiry_date': cert.expiry_date.isoformat(),
        'free_expiry_date': cert.free_expiry_date.isoformat(),
        'status': 'active' if cert.expiry_date > datetime.now() else 'expired'
    } for cert in certs])

@cert_bp.route('', methods=['POST'])
def create_cert():
    user = AuthService.get_current_user(request)
    data = request.json
    
    if not data.get('domains'):
        return jsonify({'error': 'Domains are required'}), 400
    
    try:
        cert_service = CertService()
        cert = cert_service.issue_cert(
            domains=data['domains'],
            email=user.email,
            user=user
        )
        
        return jsonify({
            'id': str(cert.id),
            'domains': cert.domains,
            'expiry_date': cert.expiry_date.isoformat()
        }), 201
    except Exception as e:
        return jsonify({'error': str(e)}), 400

@cert_bp.route('/<cert_id>', methods=['GET'])
def get_cert(cert_id):
    user = AuthService.get_current_user(request)
    cert = Certificate.objects.get_or_404(id=cert_id, user=user)
    
    # 检查证书是否可续期 (在免费期最后30天内或已过期)
    can_renew = (
        (cert.free_expiry_date - datetime.now()).days <= 30 or
        cert.expiry_date <= datetime.now()
    )
    
    return jsonify({
        'id': str(cert.id),
        'domains': cert.domains,
        'issue_date': cert.issue_date.isoformat(),
        'expiry_date': cert.expiry_date.isoformat(),
        'free_expiry_date': cert.free_expiry_date.isoformat(),
        'status': 'active' if cert.expiry_date > datetime.now() else 'expired',
        'can_renew': can_renew,
        'certificate': open(f"{cert.cert_path}/cert.pem").read(),
        'private_key': open(f"{cert.cert_path}/privkey.pem").read(),
        'chain': open(f"{cert.cert_path}/chain.pem").read()
    })
```

## 前端用户界面实现
### 登录组件
```vue
<template>
  <div class="login-container">
    <el-card class="login-box">
      <h2>登录</h2>
      
      <el-form ref="form" :model="form" :rules="rules" @submit.native.prevent="login">
        <el-form-item prop="username">
          <el-input
            v-model="form.username"
            placeholder="用户名"
            prefix-icon="el-icon-user"
          />
        </el-form-item>
        
        <el-form-item prop="password">
          <el-input
            v-model="form.password"
            type="password"
            placeholder="密码"
            prefix-icon="el-icon-lock"
            show-password
          />
        </el-form-item>
        
        <el-form-item>
          <el-button
            type="primary"
            native-type="submit"
            :loading="loading"
            class="login-btn"
          >
            登录
          </el-button>
        </el-form-item>
      </el-form>
      
      <div class="links">
        <router-link to="/register">注册新账号</router-link>
        <router-link to="/forgot-password">忘记密码?</router-link>
      </div>
    </el-card>
  </div>
</template>
<script>
import { mapActions } from 'vuex'

export default {
  data() {
    return {
      form: {
        username: '',
        password: ''
      },
      rules: {
        username: [
          { required: true, message: '请输入用户名', trigger: 'blur' }
        ],
        password: [
          { required: true, message: '请输入密码', trigger: 'blur' }
        ]
      },
      loading: false
    }
  },
  methods: {
    ...mapActions('auth', ['login']),
    
    async login() {
      this.$refs.form.validate(async valid => {
        if (valid) {
          this.loading = true
          try {
            await this.$store.dispatch('auth/login', this.form)
            this.$router.push('/dashboard')
          } catch (error) {
            this.$message.error(
              error.response?.data?.error || '登录失败，请重试'
            )
          } finally {
            this.loading = false
          }
        }
      })
    }
  }
}
</script>
<style scoped>
.login-container {
  display: flex;
  justify-content: center;
  align-items: center;
  min-height: 100vh;
  background: #f5f7fa;
}

.login-box {
  width: 400px;
  padding: 20px;
}

h2 {
  text-align: center;
  margin-bottom: 20px;
  color: #303133;
}

.login-btn {
  width: 100%;
}

.links {
  display: flex;
  justify-content: space-between;
  margin-top: 15px;
  font-size: 14px;
}

a {
  color: #409eff;
  text-decoration: none;
}
</style>
```

## 证书列表页面
```vue
<template>
  <div class="certificate-list">
    <el-row justify="space-between" align="middle" class="mb-20">
      <el-col :span="12">
        <h2>我的SSL证书</h2>
      </el-col>
      <el-col :span="12" class="text-right">
        <el-button
          type="primary"
          icon="el-icon-plus"
          @click="$router.push('/certificates/create')"
        >
          申请新证书
        </el-button>
      </el-col>
    </el-row>
    
    <el-table :data="certificates" v-loading="loading">
      <el-table-column prop="domains" label="域名" min-width="200">
        <template #default="{ row }">
          <router-link :to="`/certificates/${row.id}`">
            {{ row.domains }}
          </router-link>
        </template>
      </el-table-column>
      
      <el-table-column prop="issue_date" label="申请日期" width="150">
        <template #default="{ row }">
          {{ formatDate(row.issue_date) }}
        </template>
      </el-table-column>
      
      <el-table-column prop="expiry_date" label="过期日期" width="150">
        <template #default="{ row }">
          <span :class="{'text-danger': isExpired(row.expiry_date)}">
            {{ formatDate(row.expiry_date) }}
          </span>
        </template>
      </el-table-column>
      
      <el-table-column prop="status" label="状态" width="120">
        <template #default="{ row }">
          <el-tag
            :type="getStatusType(row.status)"
            size="small"
          >
            {{ row.status === 'active' ? '有效' : '已过期' }}
          </el-tag>
        </template>
      </el-table-column>
      
      <el-table-column label="操作" width="180">
        <template #default="{ row }">
          <el-button
            size="mini"
            @click="$router.push(`/certificates/${row.id}/renew`)"
            v-if="row.can_renew"
          >
            续期
          </el-button>
          <el-button
            size="mini"
            @click="$router.push(`/certificates/${row.id}`)"
          >
            详情
          </el-button>
        </template>
      </el-table-column>
    </el-table>
  </div>
</template>
<script>
import { mapState, mapActions } from 'vuex'

export default {
  data() {
    return {
      loading: false
    }
  },
  computed: {
    ...mapState('certs', ['certificates'])
  },
  created() {
    this.loadCertificates()
  },
  methods: {
    ...mapActions('certs', ['fetchCertificates']),
    
    async loadCertificates() {
      this.loading = true
      try {
        await this.fetchCertificates()
      } catch (error) {
        this.$message.error('加载证书失败: ' + (error.response?.data?.message || error.message))
      } finally {
        this.loading = false
      }
    },
    
    formatDate(date) {
      return new Date(date).toLocaleDateString()
    },
    
    isExpired(expiryDate) {
      return new Date(expiryDate) < new Date()
    },
    
    getStatusType(status) {
      return status === 'active' ? 'success' : 'danger'
    }
  }
}
</script>
<style scoped>
.certificate-list {
  padding: 20px;
}

.mb-20 {
  margin-bottom: 20px;
}

.text-right {
  text-align: right;
}

.text-danger {
  color: #f56c6c;
}
</style>
```

## 路由保护与导航
```javascript
import Vue from 'vue'
import VueRouter from 'vue-router'
import store from '@/store'

Vue.use(VueRouter)

const routes = [
  {
    path: '/login',
    name: 'Login',
    component: () => import('@/views/Auth/Login.vue'),
    meta: { guest: true }
  },
  {
    path: '/register',
    name: 'Register',
    component: () => import('@/views/Auth/Register.vue'),
    meta: { guest: true }
  },
  {
    path: '/forgot-password',
    name: 'ForgotPassword',
    component: () => import('@/views/Auth/ForgotPassword.vue'),
    meta: { guest: true }
  },
  {
    path: '/reset-password',
    name: 'ResetPassword',
    component: () => import('@/views/Auth/ResetPassword.vue'),
    meta: { guest: true }
  },
  {
    path: '/dashboard',
    name: 'Dashboard',
    component: () => import('@/views/Dashboard.vue'),
    meta: { requiresAuth: true }
  },
  {
    path: '/certificates',
    name: 'Certificates',
    component: () => import('@/views/Certificates/List.vue'),
    meta: { requiresAuth: true }
  },
  {
    path: '/certificates/create',
    name: 'CreateCertificate',
    component: () => import('@/views/Certificates/Create.vue'),
    meta: { requiresAuth: true }
  },
  {
    path: '/certificates/:id',
    name: 'CertificateDetail',
    component: () => import('@/views/Certificates/Detail.vue'),
    meta: { requiresAuth: true }
  },
  {
    path: '/certificates/:id/renew',
    name: 'RenewCertificate',
    component: () => import('@/views/Certificates/Renew.vue'),
    meta: { requiresAuth: true }
  },
  {
    path: '*',
    redirect: '/dashboard'
  }
]

const router = new VueRouter({
  mode: 'history',
  base: process.env.BASE_URL,
  routes
})

router.beforeEach(async (to, from, next) => {
  const requiresAuth = to.matched.some(record => record.meta.requiresAuth)
  const guest = to.matched.some(record => record.meta.guest)
  
  await store.dispatch('auth/loadUser')
  const isAuthenticated = store.state.auth.isAuthenticated
  
  if (requiresAuth && !isAuthenticated) {
    next('/login')
  } else if (guest && isAuthenticated) {
    next('/dashboard')
  } else {
    next()
  }
})

export default router
```

## 导航栏组件
```vue
<template>
  <el-header class="navbar">
    <el-row align="middle">
      <el-col :span="12">
        <router-link to="/dashboard" class="logo">
          SSL证书服务
        </router-link>
      </el-col>
      
      <el-col :span="12" class="text-right">
        <el-dropdown v-if="user" @command="handleCommand">
          <span class="el-dropdown-link">
            <el-avatar :size="30" :src="user.avatar || ''" class="mr-10" />
            {{ user.username }}<i class="el-icon-arrow-down el-icon--right"></i>
          </span>
          <el-dropdown-menu slot="dropdown">
            <el-dropdown-item command="profile">个人资料</el-dropdown-item>
            <el-dropdown-item command="logout">退出登录</el-dropdown-item>
          </el-dropdown-menu>
        </el-dropdown>
        
        <div v-else>
          <router-link to="/login" class="login-btn">登录</router-link>
          <router-link to="/register" class="register-btn">注册</router-link>
        </div>
      </el-col>
    </el-row>
  </el-header>
</template>
<script>
import { mapState, mapActions } from 'vuex'

export default {
  computed: {
    ...mapState('auth', ['user'])
  },
  methods: {
    ...mapActions('auth', ['logout']),
    
    handleCommand(command) {
      if (command === 'logout') {
        this.logout()
        this.$router.push('/login')
      } else if (command === 'profile') {
        this.$router.push('/profile')
      }
    }
  }
}
</script>
<style scoped>
.navbar {
  background: #fff;
  box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
  line-height: 60px;
}

.logo {
  font-size: 18px;
  font-weight: bold;
  color: #303133;
  text-decoration: none;
}

.text-right {
  text-align: right;
}

.el-dropdown-link {
  cursor: pointer;
}

.mr-10 {
  margin-right: 10px;
}

.login-btn, .register-btn {
  padding: 0 15px;
  color: #606266;
  text-decoration: none;
}

.register-btn {
  color: #409eff;
}
</style>
```

## 系统完整工作流程
1. **用户注册**:
   - 访问注册页面填写用户名、邮箱和密码
   - 系统发送验证邮件
   - 用户点击验证链接完成注册

2. **用户登录**:
   - 访问登录页面输入凭证
   - 获得JWT令牌用于后续认证

3. **申请证书**:
   - 登录用户访问证书申请页面
   - 输入域名信息提交申请
   - 系统使用Let's Encrypt API颁发证书
   - 证书信息保存并与用户关联

4. **管理证书**:
   - 用户可在仪表板查看所有证书
   - 查看证书详情包括密钥和到期时间
   - 在免费期结束前收到提醒邮件
   - 免费期结束后可付费续期

5. **续期证书**:
   - 用户选择支付方式完成支付
   - 系统验证支付后延长证书有效期
   - 证书自动续期无需重新颁发

## 部署和测试注意事项
1. **环境准备**:
   - 配置SMTP邮件服务
   - 配置支付服务提供商账户
   - 设置Let's Encrypt生产环境账户

2. **测试要点**:
   - 完整的用户注册/登录流程
   - 证书申请和验证过程
   - 支付流程和回调处理
   - 各种错误情况的处理

3. **安全考虑**:
   - 所有密码必须哈希存储
   - 使用HTTPS保护所有通信
   - 实施CSRF保护
   - 敏感的配置通过环境变量管理

这个完整的用户管理系统实现了注册、登录、证书申请和管理的全流程，并与支付系统集成实现了3个月免费使用后收费续期的业务需求。系统设计考虑了安全性、可扩展性和良好的用户体验。
