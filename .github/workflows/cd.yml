name: CD

on:
  push:
    branches: [ master ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Configure SSH
      run: |
        mkdir -p ~/.ssh
        echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
        chmod 600 ~/.ssh/id_rsa
        ssh-keyscan -H ${{ secrets.DEPLOY_HOST }} >> ~/.ssh/known_hosts
    
    - name: Deploy to production
      run: |
        ssh ${{ secrets.DEPLOY_USER }}@${{ secrets.DEPLOY_HOST }} << 'ENDSSH'
          set -e
          
          # 备份当前部署
          cd /path/to/freessl
          TIMESTAMP=$(date +"%Y%m%d%H%M%S")
          mkdir -p backups/$TIMESTAMP
          docker-compose -f free_ssl_service/docker-compose.prod.yml down --volumes > backups/$TIMESTAMP/down.log 2>&1 || true
          
          # 更新代码
          git pull origin master
          
          # 更新环境变量
          cp .env.production .env || true
          
          # 构建和启动服务
          docker-compose -f free_ssl_service/docker-compose.prod.yml build --pull
          docker-compose -f free_ssl_service/docker-compose.prod.yml up -d
          
          # 清理旧镜像
          docker image prune -f
          
          # 检查服务状态
          docker-compose -f free_ssl_service/docker-compose.prod.yml ps
          
          # 清理30天前的备份
          find backups -type d -mtime +30 -exec rm -rf {} \;
        ENDSSH
    
    - name: Health check
      run: |
        sleep 60
        curl -f https://${{ secrets.DEPLOY_DOMAIN }}/health || {
          echo "Health check failed, rolling back..."
          ssh ${{ secrets.DEPLOY_USER }}@${{ secrets.DEPLOY_HOST }} << 'ENDSSH'
            cd /path/to/freessl
            LATEST_BACKUP=$(ls -1 backups/ | sort -r | head -1)
            if [ -n "$LATEST_BACKUP" ]; then
              docker-compose -f free_ssl_service/docker-compose.prod.yml down
              cp -r backups/$LATEST_BACKUP/* .
              docker-compose -f free_ssl_service/docker-compose.prod.yml up -d
            fi
          ENDSSH
          exit 1
        }
    
    - name: Performance validation
      run: |
        curl -o /tmp/hey https://hey-release.s3.us-east-2.amazonaws.com/hey_linux_amd64
        chmod +x /tmp/hey
        /tmp/hey -n 100 -c 10 https://${{ secrets.DEPLOY_DOMAIN }}/api/status
        echo "Performance test completed successfully"
    
    - name: Notify deployment status
      if: always()
      uses: 8398a7/action-slack@v3
      with:
        status: ${{ job.status }}
        text: |
          Deployment to production ${{ job.status }}
          Commit: ${{ github.sha }}
          Author: ${{ github.actor }}
        webhook_url: ${{ secrets.SLACK_WEBHOOK }}
      env:
        SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK }}

  backup:
    runs-on: ubuntu-latest
    needs: deploy
    
    steps:
    - name: Configure SSH
      run: |
        mkdir -p ~/.ssh
        echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
        chmod 600 ~/.ssh/id_rsa
        ssh-keyscan -H ${{ secrets.DEPLOY_HOST }} >> ~/.ssh/known_hosts
    
    - name: Create backup
      run: |
        ssh ${{ secrets.DEPLOY_USER }}@${{ secrets.DEPLOY_HOST }} << 'ENDSSH'
          cd /path/to/freessl
          ./scripts/backup.sh
        ENDSSH
    
    - name: Upload backup to S3
      env:
        AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
        AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        AWS_S3_BUCKET: ${{ secrets.AWS_S3_BUCKET }}
      run: |
        aws s3 sync /var/backups/freessl s3://${{ secrets.AWS_S3_BUCKET }}/freessl-backups/ --delete
